# Changelog

## 18.12.2026 Исправленная версия класса TabSyncManager

### Объяснение исправления

Метод `updateHeartbeat()` в классе `TabSyncManager` не защищен от параллельной записи. При мультивкладочной работе несколько вкладок могут одновременно читать и записывать данные в `TAB_STORE_NAME`, что приводит к перезаписи данных других вкладок.

#### Ключевые изменения:

1. **Версионность записей**: Каждая запись в `TAB_STORE_NAME` теперь содержит поле `version`, которое инкрементируется при каждом обновлении.

2. **Оптимистичная блокировка**: 
   - Читаем текущую версию
   - Инкрементируем версию
   - Записываем с новой версией
   - Проверяем, что версия не изменилась после записи

3. **Retry механизм**: При обнаружении конфликта версии делаем до 3 попыток с экспоненциальной задержкой (50ms, 100ms, 200ms).

4. **Безопасная очистка**: Метод `cleanupDeadTabs()` также проверяет версию перед удалением, чтобы не удалить запись, которая была только что обновлена другой вкладкой.

#### Преимущества решения:

- ✅ Нет блокировок - работает быстро
- ✅ Обнаруживает конфликты записи
- ✅ Автоматически повторяет попытку при конфликте
- ✅ Не требует изменений в схеме IndexedDB (добавляется только поле `version`)
- ✅ Совместимо с существующим кодом


